name: Deploy GCP Real-time Data Pipeline

on:
  push:
    branches: [main, dev]
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  PROJECT_ID: fabled-web-172810
  REGION: us-central1
  ENVIRONMENT: ${{ github.ref == 'refs/heads/main' && 'prod' || 'dev' }}
  GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}

jobs:
  deploy-pipeline:
    name: Clean Deploy Complete Pipeline
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/dev'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: 1.5.7

    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ env.GCP_SA_KEY }}

    - name: Setup Google Cloud SDK
      uses: google-github-actions/setup-gcloud@v2

    - name: Configure Docker for GCR
      run: gcloud auth configure-docker

    # ==============================
    # PHASE 1: COMPLETE CLEANUP
    # ==============================
    - name: ðŸ§¹ Complete Environment Cleanup
      run: |
        echo "ðŸ§¹ Starting complete environment cleanup..."
        chmod +x ./scripts/cleanup-environment.sh
        ./scripts/cleanup-environment.sh ${{ env.PROJECT_ID }} ${{ env.ENVIRONMENT }} ${{ env.REGION }}

    # ==============================
    # PHASE 2: FRESH INFRASTRUCTURE
    # ==============================
    - name: ðŸ—ï¸ Initialize Terraform (Fresh)
      working-directory: ./terraform
      run: |
        echo "ðŸ—ï¸ Initializing Terraform with fresh state..."
        terraform init

    - name: ðŸ” Validate Terraform Configuration
      working-directory: ./terraform
      run: terraform validate

    - name: ðŸ“‹ Create Terraform Plan
      working-directory: ./terraform
      run: |
        echo "ðŸ“‹ Creating fresh deployment plan..."
        terraform plan -out=tfplan
      env:
        TF_VAR_project_id: ${{ env.PROJECT_ID }}
        TF_VAR_environment: ${{ env.ENVIRONMENT }}

    - name: ðŸ”„ Deploy Dataflow Template
      run: |
        echo "ðŸ”„ Building and deploying Dataflow template..."
        chmod +x ./scripts/deploy-dataflow-template.sh
        ./scripts/deploy-dataflow-template.sh ${{ env.PROJECT_ID }} ${{ env.ENVIRONMENT }} ${{ env.REGION }}

    - name: ðŸš€ Apply Infrastructure
      working-directory: ./terraform
      run: |
        echo "ðŸš€ Deploying infrastructure..."
        terraform apply -auto-approve tfplan

    - name: ðŸ” Assign IAM Roles
      run: |
        echo "ðŸ” Assigning IAM roles to service accounts..."
        chmod +x ./scripts/assign-iam-roles.sh
        ./scripts/assign-iam-roles.sh ${{ env.PROJECT_ID }} ${{ env.ENVIRONMENT }}
        
        echo "â³ Waiting for IAM propagation..."
        sleep 30

    # ==============================
    # PHASE 3: APPLICATION DEPLOYMENT
    # ==============================
    - name: âš¡ Deploy Cloud Function
      run: |
        echo "âš¡ Deploying BigQuery Table Manager Cloud Function..."
        chmod +x ./scripts/deploy-cloud-function.sh
        ./scripts/deploy-cloud-function.sh ${{ env.PROJECT_ID }} ${{ env.ENVIRONMENT }}

    - name: ðŸƒ Deploy Event Generator
      run: |
        echo "ðŸƒ Deploying Event Generator Cloud Run service..."
        chmod +x ./scripts/deploy-event-generator.sh
        ./scripts/deploy-event-generator.sh ${{ env.PROJECT_ID }} ${{ env.ENVIRONMENT }} ${{ env.REGION }}

    # ==============================
    # PHASE 4: VERIFICATION
    # ==============================
    - name: ðŸ§ª Integration Tests
      run: |
        echo "ðŸ§ª Running integration tests..."
        chmod +x ./scripts/test-table-creation.sh
        ./scripts/test-table-creation.sh ${{ env.PROJECT_ID }} ${{ env.ENVIRONMENT }}

    - name: âœ… Verify Deployment
      run: |
        echo "âœ… Verifying complete deployment..."
        
        # Check BigQuery Dataset
        DATASET="${{ env.ENVIRONMENT }}_events_dataset"
        echo "ðŸ“Š Checking BigQuery dataset: $DATASET"
        bq ls --project_id=${{ env.PROJECT_ID }} $DATASET
        
        # Check Dataflow Job
        echo "ðŸ”„ Checking Dataflow jobs..."
        gcloud dataflow jobs list --region=${{ env.REGION }} --filter="name:${{ env.ENVIRONMENT }}-*" --limit=5
        
        # Check Table Manager Cloud Run Service
        echo "âš¡ Checking Table Manager Cloud Run service..."
        gcloud run services describe ${{ env.ENVIRONMENT }}-table-manager --region=${{ env.REGION }} --format="value(status.conditions[0].status)"
        
        # Check Event Generator Cloud Run Service  
        echo "ðŸƒ Checking Event Generator Cloud Run service..."
        gcloud run services describe ${{ env.ENVIRONMENT }}-event-generator --region=${{ env.REGION }} --format="value(status.conditions[0].status)"
        
        echo "ðŸŽ‰ All services verified successfully!"

    # ==============================
    # PHASE 5: START TEST LOAD
    # ==============================
    - name: ðŸ§ª Start Medium Test Load
      run: |
        echo "ðŸ§ª Starting medium test load to verify complete pipeline..."
        
        # Get Event Generator service URL
        EVENT_GENERATOR_URL=$(gcloud run services describe ${{ env.ENVIRONMENT }}-event-generator --region=${{ env.REGION }} --format="value(status.url)")
        echo "ðŸ“ Event Generator URL: $EVENT_GENERATOR_URL"
        
        # Wait for services to be fully ready
        sleep 30
        
        # Start a medium test load scenario
        echo "ðŸš€ Starting medium test load (5 minutes, 60 events/minute)..."
        curl -X POST "$EVENT_GENERATOR_URL/generate/start" \
          -H "Content-Type: application/json" \
          -d '{
            "events_per_minute": 60,
            "duration_minutes": 5,
            "event_types": ["order", "inventory", "user_activity"]
          }' \
          --fail --show-error --silent | jq .
        
        echo "âœ… Medium test load started successfully!"
        echo "ðŸ“Š This will generate 300 events over 5 minutes to test the pipeline"
        echo "ðŸ” Events will flow: Event Generator â†’ Pub/Sub â†’ Table Manager â†’ BigQuery"

    - name: ðŸ” Verify Event Flow and Table Creation
      run: |
        echo "ðŸ” Testing complete event pipeline flow..."
        
        EVENT_GENERATOR_URL=$(gcloud run services describe ${{ env.ENVIRONMENT }}-event-generator --region=${{ env.REGION }} --format="value(status.url)")
        
        # Wait for services to initialize
        sleep 10
        
        # Test 1: Generate a few individual events to trigger table creation
        echo "ðŸ§ª Test 1: Generating individual events to trigger table creation..."
        for event_type in order inventory user_activity; do
          echo "ðŸ“¤ Publishing $event_type event..."
          curl -X POST "$EVENT_GENERATOR_URL/generate/single/$event_type" \
            -H "Content-Type: application/json" \
            --fail --silent || echo "âš ï¸  Failed to publish $event_type event"
          sleep 2
        done
        
        # Wait for table creation
        echo "â³ Waiting 60 seconds for table creation..."
        sleep 60
        
        # Test 2: Check if BigQuery tables were created
        echo "ðŸ” Test 2: Checking BigQuery table creation..."
        DATASET="${{ env.ENVIRONMENT }}_events_dataset"
        
        for table in orders inventory user_activity; do
          echo "ðŸ“Š Checking table: $table"
          if bq show --project_id=${{ env.PROJECT_ID }} $DATASET.$table 2>/dev/null; then
            echo "âœ… Table $table exists!"
          else
            echo "âŒ Table $table not found"
          fi
        done
        
        # Test 3: Check Pub/Sub topic activity
        echo "ðŸ” Test 3: Checking Pub/Sub topic activity..."
        TOPIC_NAME="backend-events-topic"
        echo "ðŸ“¨ Checking topic: $TOPIC_NAME"
        gcloud pubsub topics describe $TOPIC_NAME --format="value(name)" || echo "âŒ Topic not found"
        
        # Test 4: Check subscription activity  
        echo "ðŸ” Test 4: Checking subscription activity..."
        SUB_NAME="backend-events-topic-sub"
        echo "ðŸ“¨ Checking subscription: $SUB_NAME"
        gcloud pubsub subscriptions describe $SUB_NAME --format="value(name)" || echo "âŒ Subscription not found"
        
        echo "âœ… Event flow verification completed!"

    - name: ðŸ“Š Monitor Pipeline Health
      run: |
        echo "ðŸ“Š Monitoring pipeline health for 2 minutes..."
        
        EVENT_GENERATOR_URL=$(gcloud run services describe ${{ env.ENVIRONMENT }}-event-generator --region=${{ env.REGION }} --format="value(status.url)")
        
        # Check pipeline components every 30 seconds for 2 minutes
        for i in {1..4}; do
          echo "ðŸ” Health check $i/4..."
          
          # Check Event Generator health
          curl -f "$EVENT_GENERATOR_URL/health" --silent | jq .
          
          # Check Table Manager health  
          TABLE_MANAGER_URL=$(gcloud run services describe ${{ env.ENVIRONMENT }}-table-manager --region=${{ env.REGION }} --format="value(status.url)")
          curl -f "$TABLE_MANAGER_URL/health" --silent | jq .
          
          # Check if tables are being created
          DATASET="${{ env.ENVIRONMENT }}_events_dataset"
          TABLES=$(bq ls --project_id=${{ env.PROJECT_ID }} $DATASET --format="value(tableId)" 2>/dev/null | wc -l)
          echo "ðŸ“Š BigQuery tables created: $TABLES"
          
          sleep 30
        done
        
        echo "âœ… Pipeline monitoring completed!"

  # ==============================
  # CLEANUP ON FAILURE
  # ==============================
  cleanup-on-failure:
    name: Cleanup on Failure
    runs-on: ubuntu-latest
    needs: deploy-pipeline
    if: failure() && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/dev')
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ env.GCP_SA_KEY }}

    - name: Setup Google Cloud SDK
      uses: google-github-actions/setup-gcloud@v2

    - name: ðŸ§¹ Emergency Cleanup
      run: |
        echo "ðŸš¨ Deployment failed - running emergency cleanup..."
        chmod +x ./scripts/cleanup-environment.sh
        ./scripts/cleanup-environment.sh ${{ env.PROJECT_ID }} ${{ env.ENVIRONMENT }} ${{ env.REGION }}
        echo "âœ… Emergency cleanup completed" 