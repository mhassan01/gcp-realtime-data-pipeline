name: Deploy GCP Real-time Data Pipeline

on:
  push:
    branches: [main, dev]
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  PROJECT_ID: fabled-web-172810
  REGION: us-central1
  ENVIRONMENT: ${{ github.ref == 'refs/heads/main' && 'prod' || 'dev' }}
  GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}

jobs:
  deploy-pipeline:
    name: Clean Deploy Complete Pipeline
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/dev'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: 1.5.7

    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ env.GCP_SA_KEY }}

    - name: Setup Google Cloud SDK
      uses: google-github-actions/setup-gcloud@v2

    - name: Configure Docker for GCR
      run: gcloud auth configure-docker

    # ==============================
    # PHASE 1: COMPLETE CLEANUP
    # ==============================
    - name: ğŸ§¹ Complete Environment Cleanup
      run: |
        echo "ğŸ§¹ Starting complete environment cleanup..."
        chmod +x ./scripts/cleanup-environment.sh
        ./scripts/cleanup-environment.sh ${{ env.PROJECT_ID }} ${{ env.ENVIRONMENT }} ${{ env.REGION }}

    # ==============================
    # PHASE 2: FRESH INFRASTRUCTURE
    # ==============================
    - name: ğŸ—ï¸ Initialize Terraform (Fresh)
      working-directory: ./terraform
      run: |
        echo "ğŸ—ï¸ Initializing Terraform with fresh state..."
        terraform init

    - name: ğŸ” Validate Terraform Configuration
      working-directory: ./terraform
      run: terraform validate

    - name: ğŸ“‹ Create Terraform Plan
      working-directory: ./terraform
      run: |
        echo "ğŸ“‹ Creating fresh deployment plan..."
        terraform plan -out=tfplan
      env:
        TF_VAR_project_id: ${{ env.PROJECT_ID }}
        TF_VAR_environment: ${{ env.ENVIRONMENT }}

    - name: ğŸš€ Apply Infrastructure
      working-directory: ./terraform
      run: |
        echo "ğŸš€ Deploying infrastructure..."
        terraform apply -auto-approve tfplan

    - name: ğŸ” Assign IAM Roles
      run: |
        echo "ğŸ” Assigning IAM roles to service accounts..."
        chmod +x ./scripts/assign-iam-roles.sh
        ./scripts/assign-iam-roles.sh ${{ env.PROJECT_ID }} ${{ env.ENVIRONMENT }}
        
        echo "â³ Waiting for IAM propagation..."
        sleep 30

    # ==============================
    # PHASE 3: APPLICATION DEPLOYMENT
    # ==============================
    - name: âš¡ Deploy Cloud Function
      run: |
        echo "âš¡ Deploying BigQuery Table Manager Cloud Function..."
        chmod +x ./scripts/deploy-cloud-function.sh
        ./scripts/deploy-cloud-function.sh ${{ env.PROJECT_ID }} ${{ env.ENVIRONMENT }}

    - name: ğŸ”„ Deploy Dataflow Template
      run: |
        echo "ğŸ”„ Building and deploying Dataflow template..."
        chmod +x ./scripts/deploy-dataflow-template.sh
        ./scripts/deploy-dataflow-template.sh ${{ env.PROJECT_ID }} ${{ env.ENVIRONMENT }} ${{ env.REGION }}

    # ==============================
    # PHASE 4: VERIFICATION
    # ==============================
    - name: ğŸ§ª Integration Tests
      run: |
        echo "ğŸ§ª Running integration tests..."
        chmod +x ./scripts/test-table-creation.sh
        ./scripts/test-table-creation.sh ${{ env.PROJECT_ID }} ${{ env.ENVIRONMENT }}

    - name: âœ… Verify Deployment
      run: |
        echo "âœ… Verifying complete deployment..."
        
        # Check BigQuery Dataset
        DATASET="${{ env.ENVIRONMENT }}_events_dataset"
        echo "ğŸ“Š Checking BigQuery dataset: $DATASET"
        bq ls --project_id=${{ env.PROJECT_ID }} $DATASET
        
        # Check Dataflow Job
        echo "ğŸ”„ Checking Dataflow jobs..."
        gcloud dataflow jobs list --region=${{ env.REGION }} --filter="name:${{ env.ENVIRONMENT }}-*" --limit=5
        
        # Check Cloud Function
        echo "âš¡ Checking Cloud Function..."
        gcloud functions describe ${{ env.ENVIRONMENT }}-table-manager --region=${{ env.REGION }} --format="value(status)"
        
        # Check Cloud Run Service  
        echo "ğŸƒ Checking Cloud Run service..."
        gcloud run services describe ${{ env.ENVIRONMENT }}-event-generator --region=${{ env.REGION }} --format="value(status.conditions[0].status)"
        
        echo "ğŸ‰ All services verified successfully!"

  # ==============================
  # CLEANUP ON FAILURE
  # ==============================
  cleanup-on-failure:
    name: Cleanup on Failure
    runs-on: ubuntu-latest
    needs: deploy-pipeline
    if: failure() && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/dev')
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ env.GCP_SA_KEY }}

    - name: Setup Google Cloud SDK
      uses: google-github-actions/setup-gcloud@v2

    - name: ğŸ§¹ Emergency Cleanup
      run: |
        echo "ğŸš¨ Deployment failed - running emergency cleanup..."
        chmod +x ./scripts/cleanup-environment.sh
        ./scripts/cleanup-environment.sh ${{ env.PROJECT_ID }} ${{ env.ENVIRONMENT }} ${{ env.REGION }}
        echo "âœ… Emergency cleanup completed" 